name: API

on:
    pull_request:
        branches: ['*']

jobs:
    lint:
        runs-on: ubuntu-latest
        env:
            NODE_ENV: test
            TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
            TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
            IYZIPAY_URI: ${{ secrets.IYZIPAY_URI }}
            IYZIPAY_API_KEY: ${{ secrets.IYZIPAY_API_KEY }}
            IYZIPAY_SECRET_KEY: ${{ secrets.IYZIPAY_SECRET_KEY }}
            IYZIPAY_NUMBER: ${{ secrets.IYZIPAY_NUMBER }}
            REDIS_HOST: ${{ secrets.REDIS_HOST }}
            REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
            REDIS_PORT: ${{ secrets.REDIS_PORT }}
            REDIS_USER: ${{ secrets.REDIS_USER }}
            TEST_DB_HOST: ${{ secrets.TEST_DB_HOST }}
            TEST_DB_NAME: ${{ secrets.TEST_DB_NAME }}
            TEST_DB_PASS: ${{ secrets.TEST_DB_PASS }}
            TEST_DB_PORT: ${{ secrets.TEST_DB_PORT }}
            TEST_DB_USER: ${{ secrets.TEST_DB_USER }}
            JWT_SECRET: ${{ secrets.JWT_SECRET }}
            JWT_ISSUER: ${{ secrets.JWT_ISSUER }}
            COOKIE_NAME: ${{ secrets.COOKIE_NAME }}
            COOKIE_SECRET: ${{ secrets.COOKIE_SECRET }}

        name: Test API
        steps:
            - name: Action start
              uses: actions/checkout@v3
              with:
                  fetch-depth: 2

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 7

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 16
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install

            - name: Build the project
              run: pnpm build:api

            - name: Run the tests
              run: pnpm test:api
